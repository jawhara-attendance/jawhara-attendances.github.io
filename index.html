<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨Ø§Øª Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#6f42c1; --brand-2:#8b5cf6; --gold:#c9a227;
    --ok:#0ea35a; --warn:#ff9800; --danger:#d32f2f;
    --ink:#222; --muted:#6b7280; --bg:#faf7ff; --card:#ffffff; --border:#e5e7eb; --row:#fbf9ff;
  }
  .dark{
    --bg:#0f0a1a; --card:#17112a; --ink:#f3f4f6; --muted:#a6a6b5; --border:#2a2441; --row:#120d22;
    --brand:#9d7cf8; --brand-2:#b69cff; --gold:#e3c85a;
  }
  html,body{height:100%}
  body{
    font-family:"Cairo","Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(40% 50% at 100% 0%, rgba(107,70,193,0.10), transparent 60%),
      radial-gradient(60% 70% at 0% 100%, rgba(201,162,39,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg), #fff 60%);
    color:var(--ink); text-align:center; padding:20px; margin:0; min-height:100vh; position:relative;
    transition:background .3s ease,color .3s ease;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.12;
    background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">\
<g fill="none" stroke="%23967adf" stroke-width="1">\
<path d="M0 60h120M60 0v120"/><circle cx="60" cy="60" r="18" stroke="%23c9a227" stroke-width="0.8"/></g></svg>');
    background-size:180px 180px;
  }
  header{
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    color:#fff;padding:16px 18px;border-radius:16px;
    box-shadow:0 8px 24px rgba(111,66,193,.25);
    margin:40px auto 20px; width:96%; max-width:1200px; position:relative;
  }
  .header-inner{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .header-logo{height:80px;width:auto; border-radius:10px; background:#fff; padding:6px; border:1px solid rgba(255,255,255,.35)}
  .header-title{display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1}
  .header-title h1{margin:0;font-size:24px;letter-spacing:.2px}
  .header-title .sub{font-size:14px; opacity:.95}
  #dateTime{font-size:13px;margin-top:6px;color:#f5f3ff;opacity:.95}
  .top-actions{position:absolute;left:10px;top:10px;display:flex;gap:8px;align-items:center}
  .chip{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.35);padding:6px 10px;border-radius:999px;font-size:13px}
  .btn-icon{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn-icon:hover{transform:scale(1.05)}

  .container{background:var(--card);border-radius:18px;padding:20px;box-shadow:0 8px 28px rgba(0,0,0,.08);
    width:96%;max-width:1200px;margin:0 auto;border:1px solid var(--border)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  select,input,textarea{padding:10px;margin:6px;font-size:16px;border:1px solid var(--border);border-radius:10px;transition:.25s;background:#fff;color:#111}
  .dark select,.dark input,.dark textarea{background:#130d22;color:#f2f2f8;border-color:#2b2342}
  select:focus,input:focus,textarea:focus{border-color:var(--brand);outline:none;box-shadow:0 0 0 3px rgba(139,92,246,.2)}

  button{padding:10px 14px;margin:6px;border:none;border-radius:12px;cursor:pointer;font-size:15px;color:#fff;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.12)}
  button:hover{transform:translateY(-1px)}
  .btn-primary{background:var(--brand)} .btn-ok{background:var(--ok)} .btn-warn{background:var(--warn);color:#000}
  .btn-danger{background:var(--danger)} .btn-violet{background:var(--brand-2)} .btn-blue{background:#3b82f6}
  .btn-purple{background:#915bff} .btn-gray{background:#4b5563} .btn-gold{background:var(--gold); color:#1f2937}

  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border:1px solid var(--border);overflow:hidden;border-radius:14px}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:center;font-size:16px;vertical-align:middle;background:var(--card);color:var(--ink)}
  th{background:linear-gradient(180deg, rgba(139,92,246,.18), rgba(139,92,246,.05)); color:#1f1b2e; font-weight:800}
  tbody tr:nth-child(even) td{background:var(--row)}
  td .name-input{width:95%;padding:6px;border:1px solid var(--border);border-radius:8px}

  .logo-row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
  .logo-box{display:flex;align-items:center;gap:10px}
  .logo-box img{height:80px;width:auto;border-radius:10px;object-fit:contain;background:#fff;border:1px solid var(--border);padding:4px}
  .title-center{font-weight:900;font-size:20px;color:#2d2250}
  .stats{margin-top:8px;font-weight:800;color:#2d2250}
  .small{font-size:13px;color:var(--muted)}
  .teacher-wrap{display:flex;align-items:center;gap:8px;justify-content:center;flex-wrap:wrap}
  .teacher-wrap input{max-width:260px}

  .login-card{background:var(--card);border-radius:16px;padding:18px 16px;box-shadow:0 8px 28px rgba(0,0,0,.08);
    width:290px; text-align:center;border:1px solid var(--border)}
  .cards{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch;justify-content:center;margin:10px auto}
  .role-title{font-weight:900;margin:4px 0 6px}
  .badge{display:inline-block;background:rgba(139,92,246,.12);color:#3a2b68;border:1px solid rgba(139,92,246,.35);border-radius:999px;padding:4px 10px;font-size:13px}

  #snackbar{visibility:hidden;min-width:260px;background:#2e7d32;color:#fff;text-align:center;border-radius:10px;padding:12px;position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:999}
  #snackbar.show{visibility:visible;animation:fadein .25s, fadeout .25s 2.75s}
  @keyframes fadein{from{bottom:0;opacity:0}to{bottom:18px;opacity:1}}
  @keyframes fadeout{from{bottom:18px;opacity:1}to{bottom:0;opacity:0}}

  .bell{margin-right:6px;display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg, #f6e7a8, var(--gold));border:1px solid #b79217;color:#4b3b09;font-size:14px}
  .bell:empty{display:none}

  footer{margin-top:16px;font-size:13px;color:var(--muted)}
  .footer-row{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
  .badge-flat{background:rgba(0,0,0,.05);color:#333;border:1px solid var(--border);padding:4px 10px;border-radius:999px}
  .dark .badge-flat{background:rgba(255,255,255,.08);color:#ddd;border-color:#352b59}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal-card{background:var(--card);max-width:640px;width:95%;border-radius:16px;padding:18px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:right}
  .modal-card h3{margin:0 0 10px 0;font-weight:900;color:#2d2250}
  .modal-card .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}
  .modal-card input[type="file"]{background:#fafafa;border-radius:10px}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal-logo{height:28px}

  @media print{
    body{background:#fff}
    .top-actions, header,.controls,footer,textarea,#snackbar,.send-wrapper,.login,.logout-btn,.modal,#parentView{display:none}
    .container{box-shadow:none;border:none;width:100%;margin:0;padding:0}
    .print-header{display:block !important;margin-bottom:10px}
    .print-logos{display:flex;justify-content:space-between;align-items:center;margin:6px 16px}
    .print-logos img{height:80px;width:auto}
    .print-title{font-weight:900;font-size:18px;margin:0;text-align:center;color:#111}
    .print-sub{font-size:14px;text-align:center;margin:2px 0 6px 0;color:#111}
    table{border:1px solid #000;margin:10px 12px 0 12px}
    th,td{border-bottom:1px solid #000;color:#000}
    .print-footer{margin:12px;text-align:center;font-size:12px;color:#000}
  }
  .print-header{display:none}
  .hidden{display:none !important}
  .view{margin-top:8px}
  .logout-btn{position:fixed;left:12px;top:12px}
  .attach-link{cursor:pointer;text-decoration:underline}
</style>
</head>
<body>

  <header>
    <div class="header-inner">
      <img id="moeLogoHeader" class="header-logo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©">
      <div class="header-title">
        <h1>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨Ø§Øª Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ</h1>
        <div class="sub">Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
        <div id="dateTime"></div>
      </div>
      <img id="schoolLogoHeader" class="header-logo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    </div>
    <div class="top-actions">
      <button class="btn-icon" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" onclick="toggleDarkMode()">ğŸŒ™</button>
      <button class="btn-icon" title="Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…" onclick="openInfo()">â„¹ï¸</button>
      <span class="chip">Ø¥ØµØ¯Ø§Ø± 3.0</span>
    </div>
  </header>

  <div class="print-header" id="printHeader">
    <div class="print-logos">
      <img id="moeLogoPrint" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©">
      <div style="text-align:center">
        <div class="print-title" id="govTitle">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…</div>
        <div class="print-title">Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
        <div class="print-sub">Ø³Ù„Ø·Ù†Ø© Ø¹ÙÙ…Ø§Ù†</div>
      </div>
      <img id="schoolLogoPrint" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    </div>
    <div id="printInfo" class="small" style="text-align:center"></div>
    <div class="small" id="teacherPrint" style="text-align:center"></div>
  </div>

  <div class="container">
    <div class="logo-row">
      <div class="logo-box"><img id="moeLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©"></div>
      <div class="title-center">Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
      <div class="logo-box"><img id="schoolLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"></div>
    </div>

    <button class="btn-danger logout-btn hidden" id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

    <section class="login view" id="loginView">
      <h2 style="margin-top:6px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="small">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙŠÙ„)</div>
      <div class="cards">
        <div class="login-card">
          <div class="role-title">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <div class="badge">ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©</div>
          <input id="adminPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
          <button class="btn-primary" onclick="login('admin')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
        <div class="login-card">
          <div class="role-title">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</div>
          <div class="badge">ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</div>
          <input id="teacherPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù…Ø©">
          <button class="btn-ok" onclick="login('teacher')">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</button>
        </div>
        <div class="login-card">
          <div class="role-title">ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</div>
          <div class="badge">Ø¹Ø±Ø¶ + Ø³Ø¨Ø¨ ØºÙŠØ§Ø¨ + ØµÙˆØ±Ø©</div>
          <input id="parentPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±">
          <button class="btn-violet" onclick="login('parent')">Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</button>
        </div>
      </div>
    </section>

    <section id="commonControls" class="view hidden">
      <div class="row">
        <div>
          <label>Ø§Ù„ØµÙ:</label>
          <select id="grade" onchange="updateClasses()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="5">Ø§Ù„Ø®Ø§Ù…Ø³</option>
            <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            <option value="7">Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
            <option value="8">Ø§Ù„Ø«Ø§Ù…Ù†</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
          <select id="class" onchange="loadStudents()"></select>
        </div>
      </div>

      <div class="controls row" id="teacherLine">
        <div class="teacher-wrap">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:</label>
          <input id="teacherName" type="text" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©..." oninput="saveTeacher()" />
          <button class="btn-blue" onclick="markAllPresent()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒØ­Ø§Ø¶Ø±Ø§Øª</button>
        </div>

        <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©">
        <button class="btn-primary" onclick="addStudent()">â• Ø¥Ø¶Ø§ÙØ©</button>

        <button class="btn-ok" onclick="exportToExcel()">ğŸ“Š Excel (ØªØµØ¯ÙŠØ±)</button>
        <button class="btn-violet" onclick="printList()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </section>

    <section id="tableSection" class="view hidden">
      <h2 id="classTitle" style="margin:8px 0 0 0"></h2>
      <table id="studentsTable">
        <thead>
        <tr>
          <th>Ø±Ù‚Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
          <th>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</th>
          <th id="thOptions">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
        </thead>
        <tbody id="studentsList"></tbody>
      </table>
      <div class="stats" id="statsBox">Ø§Ù„Ø­Ø¶ÙˆØ±: 0% | Ø§Ù„ØºÙŠØ§Ø¨: 0% | Ø§Ù„ØªØ£Ø®Ø±: 0%</div>

      <div class="send-wrapper" style="margin-top:16px">
        <button class="btn-gold" onclick="sendPDF()">ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ PDF</button>
      </div>
    </section>

    <section id="parentView" class="view hidden">
      <h2>Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h2>
      <div class="row">
        <div>
          <label>Ø§Ù„ØµÙ:</label>
          <select id="pGrade" onchange="buildParentClasses(); parentRefresh()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="5">Ø§Ù„Ø®Ø§Ù…Ø³</option>
            <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            <option value="7">Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
            <option value="8">Ø§Ù„Ø«Ø§Ù…Ù†</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
          <select id="pClass" onchange="buildParentStudents(); parentRefresh()"></select>
        </div>
        <div>
          <label>Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</label>
          <select id="pStudent" onchange="parentRefresh()"></select>
        </div>
      </div>
      <div id="parentPhoneWrap" class="small hidden" style="margin-bottom:6px">ğŸ“± Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø¨Ø¹Ø¯ØŒ Ø³ÙŠØ·Ù„Ø¨ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨.</div>
      <table>
        <thead>
          <tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
        </thead>
        <tbody id="parentList"></tbody>
      </table>
    </section>

  </div>

  <footer>
    <div class="footer-row">
      <span class="badge-flat">Â© Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â€” 2025</span>
      <span class="badge-flat">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…: 3.0</span>
    </div>
  </footer>

  <div id="snackbar">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>

  <div class="modal" id="infoModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <img class="modal-logo" id="infoModalLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©">
      </div>
      <div class="small" style="text-align:justify;line-height:1.9">
        <b>Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:</b> Ø±Ø¤ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´Ø¹Ø¨ØŒ Ø¹Ø±Ø¶ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§ØªØŒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ±.<br/>
        <b>Ù„Ù„Ù…Ø¹Ù„Ù…Ø©:</b> Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙØŒ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ØŒ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨/Ø§Ù„ØªØ£Ø®Ø±ØŒ Ø·Ø¨Ø§Ø¹Ø© Ùˆ PDF Ùˆ Excel.<br/>
        <b>Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±:</b> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© <b>ğŸ”´ ØºØ§Ø¦Ø¨Ø©</b> Ø³ÙŠØ¸Ù‡Ø± Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¥Ø¯Ø®Ø§Ù„ <b>Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨</b> ÙˆØ±ÙØ¹ <b>ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø°Ø±</b>ØŒ Ø«Ù… ÙŠÙÙ†Ø´Ø£ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ.<br/>
        <u>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</u> Ø§Ù„Ø£Ø¹Ø°Ø§Ø± ØªÙØ­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ ÙˆØ§Ù„Ø³Ø¨Ø¨ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸. ÙŠØªÙ… ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¹Ù„Ø§Ù…Ø© <span class="bell">ğŸ””</span> Ø°Ù‡Ø¨ÙŠØ© Ø¹Ù†Ø¯ ÙˆØ±ÙˆØ¯ Ø¹Ø°Ø± Ø¬Ø¯ÙŠØ¯.
      </div>
      <div class="actions">
        <button class="btn-primary" onclick="closeInfo()">ØªÙ…</button>
      </div>
    </div>
  </div>

  <div class="modal" id="reasonModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨</h3>
        <img class="modal-logo" id="reasonModalLogo" src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø©">
      </div>
      <div id="rmStudent" class="small"></div>
      <textarea id="reasonText" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨..." style="width:100%;height:110px;border-radius:10px"></textarea>
      <div class="small" style="margin:6px 0">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ/Ø¹Ø°Ø±)</div>
      <input type="file" id="reasonImage" accept="image/*" style="width:100%">
      <div id="phoneFieldWrap" class="hidden">
        <div class="small" style="margin-top:8px">ğŸ“± Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡:</div>
        <input type="tel" id="parentPhoneInput" placeholder="Ù…Ø«Ø§Ù„: 9689XXXXXXX" style="width:100%">
      </div>
      <div class="actions">
        <button class="btn-ok" onclick="submitReason()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¨Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
        <button class="btn-gray" onclick="closeReasonModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div class="small" style="margin-top:6px;color:var(--muted)">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
  const MOE_LOGO_URL = "https://d.top4top.io/p_3589gelyk2.png";
  const SCHOOL_LOGO_URL = "https://c.top4top.io/p_35890ssj01.png";

  const ADMIN_PASS="111000", TEACHER_PASS="001100", PARENT_PASS="112233";

  const $ = id => document.getElementById(id);
  function nowDateStr(){ return new Date().toLocaleDateString("ar-EG"); }
  function nowTimeStr(){ return new Date().toLocaleTimeString("ar-EG"); }

  function beep(duration=220, freq=880, volume=0.05){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type="sine"; o.frequency.value=freq; g.gain.value=volume;
      o.start();
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18); o.stop(ctx.currentTime + 0.2); }, duration);
    }catch(e){}
  }

  function updateDateTime(){
    const now = new Date();
    const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
    $("dateTime").textContent = `${days[now.getDay()]} - ${now.toLocaleDateString("ar-EG")} - ${now.toLocaleTimeString("ar-EG")}`;
  }
  setInterval(updateDateTime, 1000); updateDateTime();

  function currentRole(){ return localStorage.getItem("role") || ""; }
  function logout(){ localStorage.removeItem("role"); location.reload(); }

  function login(role){
    const pass = role==="admin" ? $("adminPass").value.trim()
              : role==="teacher" ? $("teacherPass").value.trim()
              : $("parentPass").value.trim();
    const ok = (role==="admin"&&pass===ADMIN_PASS)||(role==="teacher"&&pass===TEACHER_PASS)||(role==="parent"&&pass===PARENT_PASS);
    if(!ok){ alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }
    localStorage.setItem("role", role);
    routeByRole();
  }

  function routeByRole(){
    const role=currentRole();
    toggle($("logoutBtn"), !!role);
    ["moeLogoHeader","moeLogo","moeLogoPrint","infoModalLogo","reasonModalLogo"].forEach(id=>{ $(id).src = MOE_LOGO_URL; });
    ["schoolLogoHeader","schoolLogo","schoolLogoPrint"].forEach(id=>{ $(id).src = SCHOOL_LOGO_URL; });

    showOnly(role ? null : "loginView");
    toggle($("commonControls"), role==="admin"||role==="teacher");
    toggle($("tableSection"),   role==="admin"||role==="teacher");
    toggle($("parentView"),     role==="parent");

    if(role==="parent"){ buildParentClasses(); parentRefresh(); }
    else if(role==="teacher"||role==="admin"){ updateClasses(); }
  }
  function showOnly(viewId){["loginView","commonControls","tableSection","parentView"].forEach(id=>{const el=$(id); if(el) el.classList.add("hidden");}); if(viewId){$(viewId).classList.remove("hidden");}}
  function toggle(el, show){ if(!el) return; el.classList.toggle("hidden", !show); }

  function toggleDarkMode(){
    const d = document.documentElement.classList.toggle("dark");
    localStorage.setItem("darkMode", d ? "1":"0");
  }
  (function(){ if(localStorage.getItem("darkMode")==="1") document.documentElement.classList.add("dark"); })();

  function saveTeacher(){ localStorage.setItem("teacher_name", $("teacherName").value.trim()); }

  function keyFor(g,c){ return `students_${g}_${c}` } function keyForUI(){ return keyFor($("grade").value, $("class").value); }

  function saveData(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; if(!g||!c) return;
    const rows=[...document.querySelectorAll("#studentsList tr")];
    const payload = rows.map(r=>({name:r.querySelector(".name").textContent,status:r.querySelector(".status").textContent,parentPhone:r.dataset.parentPhone||"",hasNew:r.dataset.hasNew==="true",absences:JSON.parse(r.dataset.absences||"[]")}));
    localStorage.setItem(keyForUI(), JSON.stringify(payload)); updateStatsUI();
  }

  function loadStudents(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; $("studentsList").innerHTML=""; $("classTitle").textContent=""; if(!g||!c) return;
    $("classTitle").textContent=`ÙƒØ´Ù Ø§Ù„ØµÙ ${g} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${c}`;
    const saved=JSON.parse(localStorage.getItem(keyForUI())||"[]"); let hasAnyNew=false;
    saved.forEach(s=>{ const tr=createRow(s.name,s.status,s.parentPhone,s.absences||[],s.hasNew||false); if(s.hasNew) hasAnyNew=true; $("studentsList").appendChild(tr); });
    renumber(); updateStatsUI(); if(hasAnyNew){ beep(220,880,0.08); }
  }

  function updateClasses(){
    const g=$("grade").value, cls=$("class");
    $("studentsList").innerHTML=""; $("classTitle").textContent=""; cls.innerHTML=""; if(!g) return;
    const counts={5:7,6:8,7:7,8:7};
    for(let i=1;i<=counts[g];i++){ const op=document.createElement("option"); op.value=i; op.textContent="Ø§Ù„Ø´Ø¹Ø¨Ø© "+i; cls.appendChild(op); }
    loadStudents();
  }

  function createRow(name,statusText,parentPhone="",absences=[],hasNew=false){
    const role=currentRole(); const tr=document.createElement("tr");
    tr.dataset.parentPhone=parentPhone||""; tr.dataset.absences=JSON.stringify(absences||[]); tr.dataset.hasNew=hasNew?"true":"false";

    const tdNo=document.createElement("td"); tdNo.className="no"; tdNo.textContent="";
    const tdName=document.createElement("td"); tdName.className="name-cell";
    const spanName=document.createElement("span"); spanName.className="name"; spanName.textContent=name;
    const bell=document.createElement("span"); bell.className="bell"; bell.textContent=(hasNew?"ğŸ””":"");
    tdName.appendChild(bell); tdName.appendChild(spanName);

    const tdStatus=document.createElement("td"); tdStatus.className="status"; tdStatus.textContent=statusText||"âœ… Ø­Ø§Ø¶Ø±Ø©";
    const tdAttach=document.createElement("td"); updateAttachmentCell(tdAttach,absences);
    const tdSign=document.createElement("td"); tdSign.textContent="";
    const tdBtns=document.createElement("td");

    if(role==="admin"||role==="teacher"){
      const bLate=btn("btn-warn","ğŸŸ  Ù…ØªØ£Ø®Ø±Ø©",()=>{tdStatus.textContent="ğŸŸ  Ù…ØªØ£Ø®Ø±Ø©"; saveData();});
      const bAbs =btn("btn-danger","ğŸ”´ ØºØ§Ø¦Ø¨Ø©", ()=>{tdStatus.textContent="ğŸ”´ ØºØ§Ø¦Ø¨Ø©"; saveData();});
      const bEdit=btn("btn-purple","âœï¸ ØªØ¹Ø¯ÙŠÙ„", ()=>{
        const editing=tdName.querySelector("input"); if(editing) return;
        const current=spanName.textContent; const input=document.createElement("input");
        input.type="text"; input.className="name-input"; input.value=current;
        tdName.innerHTML=""; const bell2=document.createElement("span"); bell2.className="bell"; bell2.textContent=tr.dataset.hasNew==="true"?"ğŸ””":""; tdName.appendChild(bell2); tdName.appendChild(input);
        input.focus(); input.select();
        function commit(save=true){ tdName.innerHTML=""; const b3=document.createElement("span"); b3.className="bell"; b3.textContent=tr.dataset.hasNew==="true"?"ğŸ””":""; tdName.appendChild(b3); if(save){ spanName.textContent=input.value.trim()||current; } tdName.appendChild(spanName); saveData(); }
        input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") commit(true); if(e.key==="Escape") commit(false); });
        input.addEventListener("blur",()=>commit(true));
      });
      const bDel =btn("btn-danger","ğŸ—‘ï¸ Ø­Ø°Ù", ()=>{ if(confirm("Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŸ")){ tr.remove(); renumber(); saveData(); }});
      const bView=btn("btn-blue","ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±", ()=>{
        tr.dataset.hasNew="false"; tdName.querySelector(".bell").textContent=""; saveData();
        const list=JSON.parse(tr.dataset.absences||"[]"); if(!list.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø°Ø§Ø± Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯."); return; }
        const lines=list.map((a,i)=>`${i+1}- ${a.date} ${a.time}\nØ§Ù„Ø³Ø¨Ø¨: ${a.text}${a.image?' (Ù…Ø¹ Ù…Ø±ÙÙ‚)':''}`).join("\n\n");
        alert(lines);
      });
      tdBtns.append(bLate,bAbs,bEdit,bDel,bView);
    } else tdBtns.textContent="â€”";

    tr.append(tdNo,tdName,tdStatus,tdAttach,tdSign,tdBtns); return tr;
  }
  function btn(cls,txt,fn){ const b=document.createElement("button"); b.className=cls; b.textContent=txt; b.onclick=fn; return b; }

  function updateAttachmentCell(tdAttach, absences){
    tdAttach.innerHTML=""; if(!absences||!absences.length){ tdAttach.innerHTML='<span class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>'; return; }
    const count=absences.length; const latest=absences[absences.length-1]; const wrap=document.createElement("div"); const info=document.createElement("div"); info.className="small"; info.textContent=`Ø§Ù„Ø£Ø¹Ø°Ø§Ø±: ${count}`; wrap.appendChild(info);
    if(latest.image){ const a=document.createElement("a"); a.className="attach-link"; a.textContent="ğŸ“ Ø¢Ø®Ø± Ù…Ø±ÙÙ‚"; a.href=latest.image; a.target="_blank"; wrap.appendChild(a); }
    tdAttach.appendChild(wrap);
  }

  function addStudent(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const name=$("studentName").value.trim(); if(!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©");
    const tr=createRow(name); $("studentsList").appendChild(tr); $("studentName").value=""; renumber(); saveData();
  }
  function renumber(){ document.querySelectorAll("#studentsList .no").forEach((c,i)=>c.textContent=(i+1).toString()); }

  function computeStats(){
    const rows=[...document.querySelectorAll("#studentsList tr")]; const total=rows.length||1; let present=0,absent=0,late=0;
    rows.forEach(r=>{ const st=r.querySelector(".status").textContent.trim(); if(st.startsWith("ğŸ”´")) absent++; else if(st.startsWith("ğŸŸ ")) late++; else present++; });
    return {present:+(present*100/total).toFixed(1), absent:+(absent*100/total).toFixed(1), late:+(late*100/total).toFixed(1)};
  }
  function updateStatsUI(){ const s=computeStats(); $("statsBox").textContent=`Ø§Ù„Ø­Ø¶ÙˆØ±: ${s.present}% | Ø§Ù„ØºÙŠØ§Ø¨: ${s.absent}% | Ø§Ù„ØªØ£Ø®Ø±: ${s.late}%`; }
  function markAllPresent(){ const role=currentRole(); if(!(role==="admin"||role==="teacher")) return; document.querySelectorAll("#studentsList .status").forEach(s=>s.textContent="âœ… Ø­Ø§Ø¶Ø±Ø©"); saveData(); alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ÙƒØ­Ø§Ø¶Ø±Ø§Øª"); }

  function printList(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; if(!g||!c) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const now=new Date(); const day=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"][now.getDay()];
    $("printInfo").textContent=`Ø§Ù„ÙŠÙˆÙ…: ${day} - Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now.toLocaleDateString("ar-EG")} - Ø§Ù„ØµÙ ${g} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${c}`;
    $("teacherPrint").textContent=`Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: ${$("teacherName").value || "________"}`; window.print();
  }

  function exportToExcel(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; if(!g||!c) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const saved=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); if(saved.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
    const ws_data=[["Ø±Ù‚Ù…","Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±"]]; saved.forEach((s,i)=>ws_data.push([i+1,s.name,s.status||"âœ… Ø­Ø§Ø¶Ø±Ø©",(s.absences||[]).length]));
    const ws=XLSX.utils.aoa_to_sheet(ws_data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ±");
    const dateStr=new Date().toLocaleDateString("ar-EG").replace(/\//g,"-"); XLSX.writeFile(wb, `ÙƒØ´Ù_Ø§Ù„ØµÙ${g}_Ø§Ù„Ø´Ø¹Ø¨Ø©${c}_${dateStr}.xlsx`);
  }

  function showSnack(msg="âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­"){ const x=$("snackbar"); x.textContent=msg; x.className="show"; setTimeout(()=>x.className=x.className.replace("show",""),3000); }

  async function sendPDF(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; if(!g||!c) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const rows=[...document.querySelectorAll("#studentsList tr")]; if(rows.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
    const { jsPDF }=window.jspdf; const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"}); const pageW=doc.internal.pageSize.getWidth(); let y=28;
    try{ if(MOE_LOGO_URL) doc.addImage(MOE_LOGO_URL,"PNG",pageW-100,y,80,80);}catch(e){}; try{ if(SCHOOL_LOGO_URL) doc.addImage(SCHOOL_LOGO_URL,"PNG",20,y,80,80);}catch(e){}; y+=10;
    doc.setFont("Helvetica","bold"); doc.setFontSize(15); doc.text("ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…",pageW/2,y+20,{align:"center"});
    doc.setFontSize(16); doc.text("Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ",pageW/2,y+40,{align:"center"});
    doc.setFontSize(12); doc.text("Ø³Ù„Ø·Ù†Ø© Ø¹ÙÙ…Ø§Ù†",pageW/2,y+58,{align:"center"}); y+=80;
    const now=new Date(); const day=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"][now.getDay()];
    doc.setFontSize(11); doc.text(`Ø§Ù„ÙŠÙˆÙ…: ${day}   Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now.toLocaleDateString("ar-EG")}   Ø§Ù„ØµÙ ${g} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${c}`,pageW/2,y,{align:"center"});
    const tName=$("teacherName").value||"________"; doc.text(`Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: ${tName}`,pageW/2,y+18,{align:"center"}); y+=36;
    const body=rows.map((r,i)=>[(i+1).toString(), r.querySelector(".name").textContent, r.querySelector(".status").textContent||"âœ… Ø­Ø§Ø¶Ø±Ø©", JSON.parse(r.dataset.absences||"[]").length.toString(), ""]);
    doc.autoTable({ head:[["Ø±Ù‚Ù…","Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±","Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"]], body, theme:"grid", styles:{font:"Helvetica",fontSize:11,halign:"center"}, headStyles:{fillColor:[109,76,182], textColor:[255,255,255]}, startY:y });
    const s=computeStats(); let endY=doc.lastAutoTable.finalY+16; doc.setFontSize(12); doc.setFont("Helvetica","bold");
    doc.text(`Ø§Ù„Ø­Ø¶ÙˆØ±: ${s.present}%   |   Ø§Ù„ØºÙŠØ§Ø¨: ${s.absent}%   |   Ø§Ù„ØªØ£Ø®Ø±: ${s.late}%`,pageW/2,endY,{align:"center"}); endY+=20;
    doc.setFont("Helvetica","normal"); doc.setFontSize(10.5); doc.text(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙ‹Ø§ Ø¹Ø¨Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ â€” Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â€” 2025`,pageW/2,endY,{align:"center"});
    const fileName=`ØªÙ‚Ø±ÙŠØ±_Ø­Ø¶ÙˆØ±_Ø§Ù„ØµÙ${g}_Ø§Ù„Ø´Ø¹Ø¨Ø©${c}_${now.toLocaleDateString("ar-EG").replace(/\//g,"-")}.pdf`; doc.save(fileName); showSnack("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF");
  }

  function buildParentClasses(){
    const classSel=$("pClass"); classSel.innerHTML=""; const g=$("pGrade").value; if(!g) return;
    const counts={5:7,6:8,7:7,8:7}; for(let i=1;i<=counts[g];i++){ const op=document.createElement("option"); op.value=i; op.textContent="Ø§Ù„Ø´Ø¹Ø¨Ø© "+i; classSel.appendChild(op); }
    buildParentStudents();
  }
  function buildParentStudents(){
    const g=$("pGrade").value, c=$("pClass").value, sSel=$("pStudent"); sSel.innerHTML=""; if(!g||!c) return;
    const list=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); if(!list.length){ const op=document.createElement("option"); op.value=""; op.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø§Øª"; sSel.appendChild(op); return; }
    sSel.appendChild(new Option("-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨Ø© --","")); list.forEach(x=>sSel.appendChild(new Option(x.name,x.name)));
  }
  function parentRefresh(){
    const g=$("pGrade").value, c=$("pClass").value, name=$("pStudent").value, tb=$("parentList"); tb.innerHTML=""; if(!g||!c) return;
    const saved=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); const arr=name? saved.filter(x=>x.name===name):saved;
    arr.forEach(s=>{
      const tr=document.createElement("tr"); const td1=el("td",s.name); const td2=el("td",s.status||"âœ… Ø­Ø§Ø¶Ø±Ø©");
      const td3=document.createElement("td"); const abs=s.absences||[];
      if(abs.length){ const latest=abs[abs.length-1]; const wrap=el("div",""); wrap.className="small"; wrap.textContent=`Ø§Ù„Ø£Ø¹Ø°Ø§Ø±: ${abs.length}`; if(latest.image){ const a=document.createElement("a"); a.className="attach-link"; a.textContent="ğŸ“ Ø¢Ø®Ø± Ù…Ø±ÙÙ‚"; a.href=latest.image; a.target="_blank"; wrap.appendChild(document.createTextNode(" ")); wrap.appendChild(a);} td3.appendChild(wrap);}
      else td3.innerHTML='<span class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';
      const td4=document.createElement("td");
      if((s.status||"").startsWith("ğŸ”´")){ const btn=document.createElement("button"); btn.className="btn-ok"; btn.textContent="âœï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨"; btn.onclick=()=>openReasonModal(g,c,s.name); td4.appendChild(btn); }
      else td4.innerHTML='<span class="small">â€”</span>';
      tr.append(td1,td2,td3,td4); tb.appendChild(tr);
    });
    if(g&&c&&name){ const data=findStudentRecord(g,c,name); const hasPhone=data&&data.parentPhone; toggle($("parentPhoneWrap"), !hasPhone); } else toggle($("parentPhoneWrap"), true);
  }
  function el(tag,txt){ const t=document.createElement(tag); t.textContent=txt; return t; }
  function findStudentRecord(g,c,name){ const key=keyFor(g,c); const list=JSON.parse(localStorage.getItem(key)||"[]"); return list.find(x=>x.name===name); }
  function updateStudentRecord(g,c,updater){ const key=keyFor(g,c); const list=JSON.parse(localStorage.getItem(key)||"[]"); const out=updater(list); localStorage.setItem(key, JSON.stringify(out)); }

  let modalCtx=null;
  function openReasonModal(grade,classNum,studentName){
    modalCtx={grade,classNum,studentName};
    $("rmStudent").textContent=`Ø§Ù„Ø·Ø§Ù„Ø¨Ø©: ${studentName} â€” Ø§Ù„ØµÙ ${grade} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${classNum}`;
    $("reasonText").value=""; $("reasonImage").value="";
    const rec=findStudentRecord(grade,classNum,studentName); const needPhone=!(rec&&rec.parentPhone); toggle($("phoneFieldWrap"), needPhone); if(needPhone) $("parentPhoneInput").value="";
    $("reasonModal").classList.add("show");
  }
  function closeReasonModal(){ $("reasonModal").classList.remove("show"); }

  function submitReason(){
    if(!modalCtx) return; const {grade,classNum,studentName}=modalCtx;
    const text=($("reasonText").value||"").trim(); if(!text){ alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨."); return; }
    const file=$("reasonImage").files && $("reasonImage").files[0];
    let phone=""; const rec=findStudentRecord(grade,classNum,studentName);
    if(rec&&rec.parentPhone){ phone=rec.parentPhone; } else { phone=($("parentPhoneInput").value||"").trim(); if(!phone){ alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨."); return; } }
    if(file){ const reader=new FileReader(); reader.onload=()=>{ saveReasonRecord(grade,classNum,studentName,text, reader.result, phone); }; reader.readAsDataURL(file); }
    else{ saveReasonRecord(grade,classNum,studentName,text,"",phone); }
  }

  function saveReasonRecord(grade,classNum,studentName,text,imageDataUrl,phone){
    const date=nowDateStr(), time=nowTimeStr();
    updateStudentRecord(grade,classNum,(list)=> list.map(s=>{ if(s.name===studentName){ s.status=s.status||"ğŸ”´ ØºØ§Ø¦Ø¨Ø©"; s.absences=s.absences||[]; s.absences.push({date,time,text,image:imageDataUrl}); s.parentPhone=s.parentPhone||phone; s.hasNew=true; } return s; }));
    if(currentRole()==="parent"){ parentRefresh(); beep(180,700,0.07); }
    if(currentRole()==="admin"||currentRole()==="teacher"){ loadStudents(); }
    closeReasonModal(); showSnack("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¨Ø¨ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚");
    const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ….\nØ§Ø¨Ù†ØªÙƒÙ…: ${studentName}\nØ§Ù„ØµÙ: ${grade} / Ø§Ù„Ø´Ø¹Ø¨Ø©: ${classNum}\nØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨: ${date} ${time}\nØ§Ù„Ø³Ø¨Ø¨: ${text}`;
    const wa=`https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(msg)}`; window.open(wa,"_blank");
  }

  function openInfo(){ $("infoModal").classList.add("show"); }
  function closeInfo(){ $("infoModal").classList.remove("show"); }

  (function init(){
    $("teacherName").value=localStorage.getItem("teacher_name")||"";
    ["moeLogoHeader","moeLogo","moeLogoPrint","infoModalLogo","reasonModalLogo"].forEach(id=>{ $(id).src = MOE_LOGO_URL; });
    ["schoolLogoHeader","schoolLogo","schoolLogoPrint"].forEach(id=>{ $(id).src = SCHOOL_LOGO_URL; });
    if(currentRole()){ routeByRole(); } else { showOnly("loginView"); }
  })();
</script>
</body>
</html>
