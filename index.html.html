<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨Ø§Øª Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ</title>
<link rel="manifest" href="manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#6f42c1; --brand-2:#8b5cf6; --gold:#c9a227;
  --ok:#0ea35a; --warn:#ff9800; --danger:#d32f2f;
  --ink:#222; --muted:#6b7280; --bg:#faf7ff; --card:#ffffff; --border:#e5e7eb; --row:#fbf9ff;
  --shadow:0 8px 28px rgba(0,0,0,.08);
}
.dark{
  --bg:#0f0a1a; --card:#17112a; --ink:#f3f4f6; --muted:#a6a6b5; --border:#2a2441; --row:#120d22;
  --brand:#9d7cf8; --brand-2:#b69cff; --gold:#e3c85a; --shadow:0 10px 32px rgba(0,0,0,.25);
}
html,body{height:100%}
body{
  font-family:"Cairo",sans-serif;
  background:
    radial-gradient(40% 50% at 100% 0%, rgba(107,70,193,0.12), transparent 60%),
    radial-gradient(60% 70% at 0% 100%, rgba(139,92,246,0.10), transparent 60%),
    linear-gradient(180deg, var(--bg), #fff 60%);
  color:var(--ink); text-align:center; padding:20px; margin:0; min-height:100vh; position:relative;
  transition:background .3s ease,color .3s ease;
}
body::after{
  content:""; position:fixed; inset:0; pointer-events:none; opacity:.12;
  background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 120 120">\
<g fill="none" stroke="%23967adf" stroke-width="1" opacity="0.7">\
<path d="M60 10 95 35 82 78 38 78 25 35z"/>\
<path d="M10 60 35 95 78 82 78 38 35 25z"/>\
<path d="M60 110 25 85 38 42 82 42 95 85z"/>\
</g></svg>');
  background-size:180px 180px;
}
header{
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;padding:18px;border-radius:16px;
  box-shadow:0 8px 24px rgba(111,66,193,.25);
  margin:40px auto 20px; width:96%; max-width:1200px; position:relative;
}
.header-inner{display:flex; align-items:center; justify-content:center;}
.header-title{display:flex; flex-direction:column; align-items:center;}
.header-title h1{margin:0;font-size:24px;font-weight:900}
.header-title .sub{font-size:14px; opacity:.95}
#dateTime{font-size:13px;margin-top:6px;color:#f5f3ff;opacity:.95}
.top-actions{
  position:absolute;left:10px;top:10px;display:flex;flex-direction:column;gap:8px;align-items:flex-start;
}
.icon-btn{
  background:rgba(255,255,255,.20);
  border:1px solid rgba(255,255,255,.35);
  color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;
  backdrop-filter:blur(4px);
  display:flex;align-items:center;gap:8px;
  transition:.18s transform, .18s box-shadow;
}
.icon-btn:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 6px 16px rgba(0,0,0,.18)}
.icon-btn:active{transform:scale(.97)}

.bell-wrap{position:relative;display:inline-flex;align-items:center}
.bell-badge{
  position:absolute; top:-6px; inset-inline-end:-6px;
  min-width:18px;height:18px;
  background:#f6c300; color:#111; font-weight:800;font-size:12px;line-height:18px;text-align:center;
  border-radius:50%;border:1px solid #b79217;
  display:none;
}
.bell-pulse{animation:bellPulse 1.1s infinite}
@keyframes bellPulse{
  0%{filter:drop-shadow(0 0 0 rgba(246,195,0,.0))}
  50%{filter:drop-shadow(0 0 8px rgba(246,195,0,.7))}
  100%{filter:drop-shadow(0 0 0 rgba(246,195,0,.0))}
}

#topBanner{
  position:fixed; top:12px; inset-inline:0; margin:auto;
  width:fit-content; background:#10b981; color:#fff;
  padding:10px 16px; border-radius:12px; font-weight:700;
  display:none; z-index:2000;
}

.container{
  background:var(--card);border-radius:18px;padding:20px;
  box-shadow:var(--shadow);
  width:96%;max-width:1200px;margin:0 auto;border:1px solid var(--border);
}
.split-btn{position:relative; display:inline-flex; align-items:center; gap:6px}
.split-btn .caret{
  width:22px;height:34px;border-radius:10px;
  background:rgba(255,255,255,.20); border:1px solid rgba(255,255,255,.35);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer; transition:.18s transform;
}
.split-btn .caret:hover{transform:translateY(-2px)}

.menu{
  position:absolute; z-index:50; top:110%; inset-inline-start:0;
  background:var(--card); border:1px solid var(--border); border-radius:12px;
  box-shadow:var(--shadow); min-width:200px;
  padding:6px; text-align:right; display:none;
}
.menu.show{display:block; animation:fadeIn .12s ease}
.menu .item{
  display:flex; gap:10px; align-items:center;
  padding:10px; border-radius:10px; cursor:pointer;
  color:var(--ink); font-size:15px;
}
.menu .item:hover{background:rgba(139,92,246,.10)}
.menu .sep{height:1px;background:var(--border);margin:6px 0}
.menu .arrow{
  position:absolute; top:-7px; inset-inline-start:14px; width:12px; height:12px;
  transform:rotate(45deg); background:var(--card);
  border-inline-start:1px solid var(--border);
  border-top:1px solid var(--border);
}
@keyframes fadeIn{from{opacity:0;transform:translateY(-2px)} to{opacity:1;transform:none}}

table{
  width:100%;border-collapse:separate;border-spacing:0;
  margin-top:12px;border:1px solid var(--border);
  overflow:hidden;border-radius:14px;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:10px 8px;text-align:center;font-size:16px;
  vertical-align:middle;background:var(--card);color:var(--ink);
}
th{
  background:linear-gradient(180deg, rgba(139,92,246,.18), rgba(139,92,246,.05));
  font-weight:800;color:#1f1b2e;
}
tbody tr:nth-child(even) td{background:var(--row)}

.badge-clip{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 8px;border-radius:999px;
  background:#fff8db;border:1px solid #f1d76a;color:#775800;font-size:13px;
}

.notes{
  width:90%;padding:6px;border-radius:10px;
  border:1px solid var(--border); background:#fff;
}
.dark .notes{background:#130d22;color:#f7f7f7;border-color:#312345}

.icon-opts{
  background:#f3f4f6;color:#111;border:1px solid var(--border);
  padding:8px 10px;border-radius:10px;cursor:pointer;
}
.icon-opts:hover{background:#ede9fe}

#snackbar{
  visibility:hidden;min-width:260px;
  background:#2e7d32;color:#fff;text-align:center;border-radius:10px;
  padding:12px;position:fixed;left:50%;
  transform:translateX(-50%);bottom:18px;z-index:999;
}
#snackbar.show{visibility:visible;animation:fadein .25s, fadeout .25s 2.75s}

.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
  z-index:1000;backdrop-filter:blur(2px)
}
.modal.show{display:flex}
.modal-card{
  background:var(--card);max-width:640px;width:95%;
  border-radius:16px;padding:18px;border:1px solid var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:right;
}
.modal-card h3{margin:0 0 10px;font-weight:900;color:#2d2250}
.modal-card .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

.hidden{display:none !important}
.view{margin-top:8px}
</style>
</head>
<body>

  <div id="topBanner">âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­</div>

  <header>
    <div class="header-inner">
      <div class="header-title">
        <h1>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨Ø§Øª Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ</h1>
        <div class="sub">Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
        <div id="dateTime"></div>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
    <div class="top-actions" id="topActions">
      <button class="icon-btn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" onclick="toggleDarkMode()">ğŸŒ™ <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span></button>

      <!-- ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± -->
      <div id="parentBellWrap" class="hidden">
        <button class="icon-btn bell-wrap" title="ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±" onclick="openParentAlerts()">
          ğŸ”” <span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
          <span id="bellBadge" class="bell-badge">0</span>
        </button>
      </div>

      <button class="icon-btn" id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" onclick="logout()">ğŸšª <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></button>
    </div>
  </header>

  <div class="container">

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <section class="login view" id="loginView">
      <h2 style="margin-top:6px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="small">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙŠÙ„)</div>
      <div class="row" style="justify-content:center">
        <div>
          <div class="small">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <input id="adminPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
          <button class="icon-btn" onclick="login('admin')">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
        <div>
          <div class="small">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</div>
          <input id="teacherPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù…Ø©">
          <button class="icon-btn" onclick="login('teacher')">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</button>
        </div>
        <div>
          <div class="small">ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</div>
          <input id="parentPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±">
          <button class="icon-btn" onclick="login('parent')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</button>
        </div>
      </div>
    </section>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù…Ø¹Ù„Ù…Ø© -->
    <section id="commonControls" class="view hidden">
      <div class="row">
        <div>
          <label>Ø§Ù„ØµÙ:</label>
          <select id="grade" onchange="updateClasses()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="5">Ø§Ù„Ø®Ø§Ù…Ø³</option>
            <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            <option value="7">Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
            <option value="8">Ø§Ù„Ø«Ø§Ù…Ù†</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
          <select id="class" onchange="loadStudents()"></select>
        </div>
      </div>

      <div class="row" id="adminTeacherTools">
        <!-- Ø¥Ø¶Ø§ÙØ© (ÙØ±Ø¯/Ù…Ø¬Ù…ÙˆØ¹Ø©) -->
        <div class="split-btn" id="addWrap">
          <button class="icon-btn" id="addMainBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
          <div class="caret" id="addCaret">â–¾</div>
          <div class="menu" id="addMenu">
            <div class="arrow"></div>
            <div class="item" id="addOne"><span>â•</span><span>Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯</span></div>
            <div class="item hidden" id="addBulk"><span>ğŸ“‹</span><span>Ù„ØµÙ‚ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø³Ù…Ø§Ø¡ (Ø¥Ø¯Ø§Ø±Ø©)</span></div>
          </div>
        </div>

        <!-- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒØ­Ø§Ø¶Ø±Ø§Øª -->
        <button class="icon-btn" id="markAllBtn" onclick="markAllPresent()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒØ­Ø§Ø¶Ø±Ø§Øª</button>

        <!-- Ù‚Ø§Ø¦Ù…Ø© ØªØµØ¯ÙŠØ± (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·) -->
        <div class="split-btn" id="expWrap">
          <button class="icon-btn" id="expMainBtn">â¤´ï¸ ØªØµØ¯ÙŠØ±</button>
          <div class="caret" id="expCaret">â–¾</div>
          <div class="menu" id="expMenu">
            <div class="arrow"></div>
            <div class="item" onclick="exportToExcel()"><span>ğŸ“Š</span><span>ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</span></div>
            <div class="item" onclick="sendPDF()"><span>ğŸ“„</span><span>ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</span></div>
            <div class="item" onclick="printList()"><span>ğŸ–¨ï¸</span><span>Ø·Ø¨Ø§Ø¹Ø©</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª -->
    <section id="tableSection" class="view hidden">
      <h2 id="classTitle" style="margin:8px 0 0 0"></h2>
      <table id="studentsTable">
        <thead>
        <tr>
          <th>Ø±Ù‚Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
        </thead>
        <tbody id="studentsList"></tbody>
      </table>

      <div class="small" id="statsBox" style="margin-top:8px">Ø§Ù„Ø­Ø¶ÙˆØ±: 0% | Ø§Ù„ØºÙŠØ§Ø¨: 0% | Ø§Ù„ØªØ£Ø®Ø±: 0%</div>

      <div style="margin-top:16px">
        <button class="icon-btn" onclick="sendReport()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </section>

    <!-- ÙˆØ§Ø¬Ù‡Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± -->
    <section id="parentView" class="view hidden">
      <h2>Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h2>
      <div class="row">
        <div>
          <label>Ø§Ù„ØµÙ:</label>
          <select id="pGrade" onchange="buildParentClasses(); parentOnSelectorsChange()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="5">Ø§Ù„Ø®Ø§Ù…Ø³</option>
            <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            <option value="7">Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
            <option value="8">Ø§Ù„Ø«Ø§Ù…Ù†</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
          <select id="pClass" onchange="buildParentStudents(); parentOnSelectorsChange()"></select>
        </div>
        <div>
          <label>Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:</label>
          <select id="pStudent" onchange="parentOnSelectorsChange()"></select>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>
        </thead>
        <tbody id="parentList"></tbody>
      </table>
    </section>

  </div>

  <!-- Snackbar -->
  <div id="snackbar">âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­</div>

  <!-- Ù†Ø§ÙØ°Ø© Ù„ØµÙ‚ Ø¯ÙØ¹Ø© Ø£Ø³Ù…Ø§Ø¡ (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·) -->
  <div class="modal" id="bulkModal">
    <div class="modal-card">
      <h3>ğŸ“‹ Ù„ØµÙ‚ Ø¯ÙØ¹Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</h3>
      <div class="small">Ø£Ù„ØµÙ‚ÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Excel: Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø³Ù… Ø£Ùˆ Ù…ÙØµÙˆÙ„ Ø¨ÙÙˆØ§ØµÙ„/Ø›/ØŒ</div>
      <textarea id="bulkText" style="width:100%;height:160px;border-radius:10px"></textarea>
      <div class="actions">
        <button class="icon-btn" onclick="applyBulk()">âœ… Ø¥Ø¶Ø§ÙØ©</button>
        <button class="icon-btn" onclick="closeBulk()">âœ–ï¸ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø±Ù‚Ù… Ù‡Ø§ØªÙ (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©) -->
  <div class="modal" id="adminPhoneModal">
    <div class="modal-card">
      <h3>ğŸ“ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h3>
      <div class="small" id="adminPhoneTarget"></div>
      <input type="tel" id="adminPhoneInput" placeholder="Ù…Ø«Ø§Ù„: 9689XXXXXXX" style="width:100%;margin-top:8px">
      <div class="actions">
        <button class="icon-btn" onclick="saveAdminPhone()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="icon-btn" onclick="closeAdminPhone()">âœ–ï¸ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±) -->
  <div class="modal" id="parentPhoneModal">
    <div class="modal-card">
      <h3>ğŸ“± Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h3>
      <div class="small" id="parentPhoneTitle"></div>
      <input type="tel" id="parentPhoneInput" placeholder="Ù…Ø«Ø§Ù„: 9689XXXXXXX" style="width:100%;margin-top:8px">
      <div class="actions">
        <button class="icon-btn" onclick="saveParentPhone()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…</button>
        <button class="icon-btn" onclick="closeParentPhone()">âœ–ï¸ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ -->
  <div class="modal" id="reasonModal">
    <div class="modal-card">
      <h3>ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨</h3>
      <div id="rmStudent" class="small"></div>
      <textarea id="reasonText" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨..." style="width:100%;height:110px;border-radius:10px"></textarea>
      <div class="small" style="margin:6px 0">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ/Ø¹Ø°Ø±)</div>
      <input type="file" id="reasonImage" accept="image/*" style="width:100%">
      <div class="actions">
        <button class="icon-btn" onclick="submitReason()">ğŸ“¨ Ø­ÙØ¸ Ø§Ù„Ø³Ø¨Ø¨</button>
        <button class="icon-btn" onclick="closeReasonModal()">âœ–ï¸ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± -->
  <div class="modal" id="parentAlertsModal">
    <div class="modal-card">
      <h3>Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù„Ø·Ø§Ù„Ø¨Ø©</h3>
      <div id="alertsContainer" class="small" style="max-height:50vh;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:10px"></div>
      <div class="actions">
        <button class="icon-btn" onclick="closeParentAlerts()">ØªÙ…</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
  /* ===== ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ===== */
  const ADMIN_PASS="111000", TEACHER_PASS="001100", PARENT_PASS="112233";

  const $ = id => document.getElementById(id);

  /* ===== ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª ===== */
  function updateDateTime(){
    const now = new Date();
    const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
    $("dateTime").textContent = `${days[now.getDay()]} - ${now.toLocaleDateString("ar-EG")} - ${now.toLocaleTimeString("ar-EG")}`;
  }
  setInterval(updateDateTime, 1000); updateDateTime();

  /* ===== Ø£Ø¯ÙˆØ§Ø± ===== */
  function currentRole(){ return localStorage.getItem("role") || ""; }
  function logout(){ localStorage.removeItem("role"); location.reload(); }
  function login(role){
    const pass = role==="admin" ? $("adminPass").value.trim()
              : role==="teacher" ? $("teacherPass").value.trim()
              : $("parentPass").value.trim();
    const ok = (role==="admin"&&pass===ADMIN_PASS)||(role==="teacher"&&pass===TEACHER_PASS)||(role==="parent"&&pass===PARENT_PASS);
    if(!ok){ alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }
    localStorage.setItem("role", role);
    routeByRole();
  }
  function routeByRole(){
    const role=currentRole();
    showOnly(role ? null : "loginView");

    // Ø¥Ø¸Ù‡Ø§Ø± bell Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± ÙÙ‚Ø·
    const bellWrap = $("parentBellWrap");
    bellWrap.classList.toggle("hidden", role!=="parent");

    if(role==="admin"||role==="teacher"){
      $("commonControls").classList.remove("hidden");
      $("tableSection").classList.remove("hidden");
      // Bulk Ùˆ Export Ù„Ù„Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·
      $("addBulk").classList.toggle("hidden", role!=="admin");
      $("expWrap").style.display = role==="admin" ? "inline-flex" : "none";
      updateClasses();
    } else if(role==="parent"){
      $("parentView").classList.remove("hidden");
      buildParentClasses(); parentOnSelectorsChange(); // Ø³ÙŠØ®ØªØ¨Ø± Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø¬Ø±Ø³
    }
  }
  function showOnly(viewId){
    ["loginView","commonControls","tableSection","parentView"].forEach(id=>{
      const el=$(id); if(el) el.classList.add("hidden");
    });
    if(viewId){ $(viewId).classList.remove("hidden"); }
  }

  /* ===== Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ===== */
  function toggleDarkMode(){
    const d = document.documentElement.classList.toggle("dark");
    localStorage.setItem("darkMode", d ? "1":"0");
  }
  (function(){ if(localStorage.getItem("darkMode")==="1") document.documentElement.classList.add("dark"); })();

  /* ===== Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ===== */
  function keyFor(g,c){ return `students_${g}_${c}` } 
  function keyForUI(){ return keyFor($("grade").value, $("class").value); }

  /* ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø© ===== */
  function updateClasses(){
    const g=$("grade").value, cls=$("class");
    $("studentsList").innerHTML=""; $("classTitle").textContent=""; cls.innerHTML=""; if(!g) return;
    const counts={5:7,6:8,7:7,8:7};
    for(let i=1;i<=counts[g];i++){ const op=document.createElement("option"); op.value=i; op.textContent="Ø§Ù„Ø´Ø¹Ø¨Ø© "+i; cls.appendChild(op); }
    loadStudents();
  }
  function loadStudents(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; $("studentsList").innerHTML=""; $("classTitle").textContent=""; if(!g||!c) return;
    $("classTitle").textContent=`ÙƒØ´Ù Ø§Ù„ØµÙ ${g} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${c}`;
    const saved=JSON.parse(localStorage.getItem(keyForUI())||"[]");
    saved.forEach(s=>{ const tr=createRow(s.name,s.status,s.parentPhone,s.absences||[],s.hasNew||false,s.notes||""); $("studentsList").appendChild(tr); });
    renumber(); updateStatsUI();
  }

  /* ===== Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
  function createRow(name,statusText,parentPhone="",absences=[],hasNew=false,notesVal=""){
    const role=currentRole(); const tr=document.createElement("tr");
    tr.dataset.parentPhone=parentPhone||""; tr.dataset.absences=JSON.stringify(absences||[]); tr.dataset.hasNew=hasNew?"true":"false";

    const tdNo=document.createElement("td"); tdNo.className="no"; tdNo.textContent="";
    const tdName=document.createElement("td");
    const spanName=document.createElement("span"); spanName.className="name"; spanName.textContent=name;
    tdName.appendChild(spanName);

    const tdStatus=document.createElement("td"); tdStatus.className="status"; tdStatus.textContent=statusText||"âœ… Ø­Ø§Ø¶Ø±Ø©";

    const tdAttach=document.createElement("td"); updateAttachmentCell(tdAttach,absences);

    const tdNotes=document.createElement("td");
    const notes=document.createElement("input"); notes.type="text"; notes.className="notes"; notes.placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."; notes.value=notesVal||"";
    notes.oninput = saveData; tdNotes.appendChild(notes);

    const tdBtns=document.createElement("td");
    if(role==="admin"||role==="teacher"){
      const bLate = iconBtn("btn-warn","ğŸ•’ Ù…ØªØ£Ø®Ø±Ø©",()=>{tdStatus.textContent="ğŸŸ  Ù…ØªØ£Ø®Ø±Ø©"; saveData();});
      const bAbs  = iconBtn("btn-danger","â›” ØºØ§Ø¦Ø¨Ø©", ()=>{tdStatus.textContent="ğŸ”´ ØºØ§Ø¦Ø¨Ø©"; saveData();});

      const optsBtn = document.createElement("button"); optsBtn.className="icon-opts"; optsBtn.textContent="â‹®"; optsBtn.title="Ø®ÙŠØ§Ø±Ø§Øª";
      const pop = document.createElement("div"); pop.className="menu"; pop.style.insetInlineStart="auto"; pop.style.insetInlineEnd="0";
      const arrow=document.createElement("div"); arrow.className="arrow"; arrow.style.insetInline="auto 14px"; pop.appendChild(arrow);
      const itEdit=document.createElement("div"); itEdit.className="item"; itEdit.innerHTML="âœï¸ <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</span>";
      const itPhone=document.createElement("div"); itPhone.className="item"; itPhone.innerHTML="ğŸ“ <span>Ø±Ù‚Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</span>";
      const itDel =document.createElement("div"); itDel.className="item"; itDel.innerHTML="ğŸ—‘ï¸ <span>Ø­Ø°Ù</span>";

      itEdit.onclick=()=>{
        const editing=tdName.querySelector("input"); if(editing) return;
        const current=spanName.textContent; const input=document.createElement("input");
        input.type="text"; input.className="notes"; input.value=current;
        tdName.innerHTML=""; tdName.appendChild(input);
        input.focus(); input.select();
        function commit(save=true){
          tdName.innerHTML="";
          if(save){ spanName.textContent=input.value.trim()||current; }
          tdName.appendChild(spanName); saveData();
        }
        input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") commit(true); if(e.key==="Escape") commit(false); });
        input.addEventListener("blur",()=>commit(true));
        pop.classList.remove("show");
      };

      itPhone.onclick=()=>{ openAdminPhoneModal(spanName.textContent, tr); pop.classList.remove("show"); };
      itDel.onclick=()=>{ pop.classList.remove("show"); if(confirm("Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŸ")){ tr.remove(); renumber(); saveData(); } };

      pop.appendChild(itEdit); pop.appendChild(itPhone);
      const sep=document.createElement("div"); sep.className="sep"; pop.appendChild(sep);
      pop.appendChild(itDel);

      tdBtns.append(bLate,bAbs,optsBtn);
      tdBtns.style.position="relative"; tdBtns.appendChild(pop);
      optsBtn.onclick = (e)=>{ e.stopPropagation(); closeAllMenus(); pop.classList.toggle("show"); };
      document.addEventListener("click",()=> pop.classList.remove("show"));
    } else tdBtns.textContent="â€”";

    tr.append(tdNo,tdName,tdStatus,tdAttach,tdNotes,tdBtns); 
    return tr;
  }
  function iconBtn(cls,txt,fn){ const b=document.createElement("button"); b.className=cls+" icon-btn"; b.textContent=txt; b.onclick=fn; return b; }

  function updateAttachmentCell(tdAttach, absences){
    tdAttach.innerHTML="";
    if(!absences||!absences.length){ tdAttach.innerHTML='<span class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>'; return; }
    const latest=absences[absences.length-1];
    const pill=document.createElement("span"); pill.className="badge-clip"; pill.innerHTML="ğŸ“ <span>Ù…Ø±ÙÙ‚</span>";
    if(latest.image){ pill.style.cursor="pointer"; pill.title="ÙØªØ­ Ø¢Ø®Ø± Ù…Ø±ÙÙ‚"; pill.onclick=()=> window.open(latest.image,"_blank"); }
    tdAttach.appendChild(pill);
  }

  /* ===== Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
  function saveData(){
    const role=currentRole(); if(!(role==="admin"||role==="teacher")) return;
    const g=$("grade").value,c=$("class").value; if(!g||!c) return;
    const rows=[...document.querySelectorAll("#studentsList tr")];
    const payload = rows.map(r=>({
      name:r.querySelector(".name").textContent,
      status:r.querySelector(".status").textContent,
      notes:r.querySelector(".notes").value || "",
      parentPhone:r.dataset.parentPhone||"",
      hasNew:r.dataset.hasNew==="true",
      absences:JSON.parse(r.dataset.absences||"[]")
    }));
    localStorage.setItem(keyForUI(), JSON.stringify(payload)); updateStatsUI();
  }
  function renumber(){ document.querySelectorAll("#studentsList .no").forEach((c,i)=>c.textContent=(i+1).toString()); }
  function computeStats(){
    const rows=[...document.querySelectorAll("#studentsList tr")]; const total=rows.length||1; let present=0,absent=0,late=0;
    rows.forEach(r=>{ const st=r.querySelector(".status").textContent.trim(); if(st.startsWith("ğŸ”´")||st.includes("ØºØ§Ø¦Ø¨Ø©")) absent++; else if(st.startsWith("ğŸŸ ")||st.includes("Ù…ØªØ£Ø®Ø±Ø©")) late++; else present++; });
    return {present:+(present*100/total).toFixed(1), absent:+(absent*100/total).toFixed(1), late:+(late*100/total).toFixed(1)};
  }
  function updateStatsUI(){ const s=computeStats(); $("statsBox").textContent=`Ø§Ù„Ø­Ø¶ÙˆØ±: ${s.present}% | Ø§Ù„ØºÙŠØ§Ø¨: ${s.absent}% | Ø§Ù„ØªØ£Ø®Ø±: ${s.late}%`; }

  /* ===== Ø¥Ø¶Ø§ÙØ©/Ù„ØµÙ‚ Ø£Ø³Ù…Ø§Ø¡ ===== */
  function setupAddMenu(){
    const addMainBtn=$("addMainBtn"), addCaret=$("addCaret"), addMenu=$("addMenu");
    const addOne=$("addOne"), addBulk=$("addBulk");
    addMainBtn.onclick = (e)=>{ e.stopPropagation(); closeAllMenus(); addMenu.classList.toggle("show"); };
    addCaret.onclick   = (e)=>{ e.stopPropagation(); closeAllMenus(); addMenu.classList.toggle("show"); };
    addOne.onclick = ()=>{ addMenu.classList.remove("show"); const name=prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:"); if(name){ const tr=createRow(name); $("studentsList").appendChild(tr); renumber(); saveData(); } };
    addBulk.onclick = ()=>{ addMenu.classList.remove("show"); openBulk(); };
    document.addEventListener("click",()=> addMenu.classList.remove("show"));
  }
  function closeAllMenus(){ document.querySelectorAll(".menu.show").forEach(m=>m.classList.remove("show")); }
  function openBulk(){ $("bulkText").value=""; $("bulkModal").classList.add("show"); }
  function closeBulk(){ $("bulkModal").classList.remove("show"); }
  function applyBulk(){
    const txt=$("bulkText").value||""; 
    const names=txt.split(/\r?\n|[,;ØŒ]+/).map(s=>s.trim()).filter(Boolean);
    if(!names.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡."); return; }
    names.forEach(n=>{ const tr=createRow(n); $("studentsList").appendChild(tr); });
    renumber(); saveData(); closeBulk(); showSnack("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­");
  }

  /* ===== Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± (Ø¥Ø¯Ø§Ø±Ø©) ===== */
  let adminPhoneCtx=null;
  function openAdminPhoneModal(studentName, tr){
    adminPhoneCtx={tr, studentName};
    $("adminPhoneTarget").textContent=`Ø§Ù„Ø·Ø§Ù„Ø¨Ø©: ${studentName}`;
    $("adminPhoneInput").value = tr.dataset.parentPhone || "";
    $("adminPhoneModal").classList.add("show");
  }
  function closeAdminPhone(){ $("adminPhoneModal").classList.remove("show"); }
  function saveAdminPhone(){
    if(!adminPhoneCtx) return;
    const phone = ($("adminPhoneInput").value||"").trim();
    adminPhoneCtx.tr.dataset.parentPhone = phone;
    saveData();
    closeAdminPhone();
    showSnack("ğŸ“ ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±");
  }

  /* ===== ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±: Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…/Ø§Ù„ØªØ­Ø¯ÙŠØ« + Ø§Ù„Ø¬Ø±Ø³ ===== */
  function buildParentClasses(){
    const classSel=$("pClass"); classSel.innerHTML=""; const g=$("pGrade").value; if(!g) return;
    const counts={5:7,6:8,7:7,8:7}; for(let i=1;i<=counts[g];i++){ const op=document.createElement("option"); op.value=i; op.textContent="Ø§Ù„Ø´Ø¹Ø¨Ø© "+i; classSel.appendChild(op); }
    buildParentStudents();
  }
  function buildParentStudents(){
    const g=$("pGrade").value, c=$("pClass").value, sSel=$("pStudent"); sSel.innerHTML=""; if(!g||!c) return;
    const list=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); if(!list.length){ const op=document.createElement("option"); op.value=""; op.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø§Øª"; sSel.appendChild(op); return; }
    sSel.appendChild(new Option("-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨Ø© --","")); list.forEach(x=>sSel.appendChild(new Option(x.name,x.name)));
  }
  function parentOnSelectorsChange(){
    const g=$("pGrade").value, c=$("pClass").value, name=$("pStudent").value;
    const tb=$("parentList"); tb.innerHTML="";
    if(!g||!c) { updateBell(0); return; }

    const saved=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); 
    const arr=name? saved.filter(x=>x.name===name):saved;
    arr.forEach(s=>{
      const tr=document.createElement("tr"); 
      tr.appendChild(el("td",s.name));
      tr.appendChild(el("td",s.status||"âœ… Ø­Ø§Ø¶Ø±Ø©"));
      const td3=document.createElement("td"); 
      if((s.absences||[]).length){
        const latest=s.absences[s.absences.length-1];
        const pill=document.createElement("span"); pill.className="badge-clip"; pill.innerHTML="ğŸ“ <span>Ù…Ø±ÙÙ‚</span>";
        if(latest.image){ pill.style.cursor="pointer"; pill.onclick=()=>window.open(latest.image,"_blank"); }
        td3.appendChild(pill);
      } else { td3.innerHTML='<span class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>'; }
      tr.appendChild(td3);
      tr.appendChild(el("td", s.notes||"â€”"));
      tb.appendChild(tr);
    });

    // Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù„Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© â†’ Ø£Ø·Ù„Ø¨Ù‡
    if(name){
      const rec = findStudentRecord(g,c,name);
      if(rec){
        const count = (rec.absences||[]).length || 0;
        updateBell(count);
        if(!rec.parentPhone){ openParentPhoneAsk(g,c,name); }
      } else { updateBell(0); }
    } else {
      const total = saved.reduce((a,b)=>a+((b.absences||[]).length||0),0);
      updateBell(total);
    }
  }
  function el(tag,txt){ const t=document.createElement(tag); t.textContent=txt; return t; }
  function findStudentRecord(g,c,name){ const key=keyFor(g,c); const list=JSON.parse(localStorage.getItem(key)||"[]"); return list.find(x=>x.name===name); }
  function updateStudentRecord(g,c,updater){ const key=keyFor(g,c); const list=JSON.parse(localStorage.getItem(key)||"[]"); const out=updater(list); localStorage.setItem(key, JSON.stringify(out)); }

  /* ===== Ù†Ø§ÙØ°Ø© Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± ===== */
  let parentPhoneCtx=null;
  function openParentPhoneAsk(grade,classNum,studentName){
    parentPhoneCtx={grade,classNum,studentName};
    $("parentPhoneTitle").textContent=`Ø§Ù„Ø·Ø§Ù„Ø¨Ø©: ${studentName} â€” Ø§Ù„ØµÙ ${grade} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${classNum}`;
    $("parentPhoneInput").value="";
    $("parentPhoneModal").classList.add("show");
  }
  function closeParentPhone(){ $("parentPhoneModal").classList.remove("show"); }
  function saveParentPhone(){
    if(!parentPhoneCtx) return;
    const phone = ($("parentPhoneInput").value||"").trim();
    if(!phone){ alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ§Ù„Ø­."); return; }
    const {grade,classNum,studentName}=parentPhoneCtx;
    updateStudentRecord(grade,classNum,(list)=> list.map(s=>{ if(s.name===studentName){ s.parentPhone=phone; } return s; }));
    closeParentPhone();
    parentOnSelectorsChange();
    showSnack("ğŸ“± ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
  }

  /* ===== Ø¬Ø±Ø³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===== */
  function updateBell(count){
    const role=currentRole(); if(role!=="parent") return;
    const badge=$("bellBadge");
    const wrap=$("parentBellWrap");
    if(count>0){
      badge.textContent=count>99?"99+":count;
      badge.style.display="inline-block";
      wrap.querySelector("button").classList.add("bell-pulse");
    }else{
      badge.style.display="none";
      wrap.querySelector("button").classList.remove("bell-pulse");
    }
  }
  function openParentAlerts(){
    const g=$("pGrade").value, c=$("pClass").value, name=$("pStudent").value;
    const container=$("alertsContainer"); container.innerHTML="";
    if(!g||!c||!name){ container.textContent="ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© ÙˆØ§Ù„Ø·Ø§Ù„Ø¨Ø©."; $("parentAlertsModal").classList.add("show"); return; }
    const rec = findStudentRecord(g,c,name);
    if(!rec){ container.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."; $("parentAlertsModal").classList.add("show"); return; }
    const list = (rec.absences||[]).slice().reverse(); // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
    if(!list.length){ container.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ ØºÙŠØ§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©."; $("parentAlertsModal").classList.add("show"); return; }

    list.forEach(a=>{
      const card=document.createElement("div");
      card.style.cssText="border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:var(--row)";
      const head=document.createElement("div"); head.innerHTML=`<b>${a.date} â€” ${a.time}</b>`;
      const body=document.createElement("div"); body.textContent=`Ø§Ù„Ø³Ø¨Ø¨: ${a.text}`;
      card.appendChild(head); card.appendChild(body);
      if(a.image){
        const link=document.createElement("a"); link.href=a.image; link.target="_blank"; link.textContent="ğŸ“ ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚";
        link.style.display="inline-block"; link.style.marginTop="6px"; card.appendChild(link);
      }
      container.appendChild(card);
    });
    $("parentAlertsModal").classList.add("show");
  }
  function closeParentAlerts(){ $("parentAlertsModal").classList.remove("show"); }

  /* ===== Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ ===== */
  let modalCtx=null;
  function openReasonModal(grade,classNum,studentName){
    modalCtx={grade,classNum,studentName};
    $("rmStudent").textContent=`Ø§Ù„Ø·Ø§Ù„Ø¨Ø©: ${studentName} â€” Ø§Ù„ØµÙ ${grade} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${classNum}`;
    $("reasonText").value=""; $("reasonImage").value="";
    $("reasonModal").classList.add("show");
  }
  function closeReasonModal(){ $("reasonModal").classList.remove("show"); }
  function nowDateStr(){ return new Date().toLocaleDateString("ar-EG"); }
  function nowTimeStr(){ return new Date().toLocaleTimeString("ar-EG"); }
  function submitReason(){
    if(!modalCtx) return; const {grade,classNum,studentName}=modalCtx;
    const text=($("reasonText").value||"").trim(); if(!text){ alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨."); return; }
    const file=$("reasonImage").files && $("reasonImage").files[0];
    if(file){ const reader=new FileReader(); reader.onload=()=>{ saveReasonRecord(grade,classNum,studentName,text, reader.result); }; reader.readAsDataURL(file); }
    else{ saveReasonRecord(grade,classNum,studentName,text,""); }
  }
  function saveReasonRecord(grade,classNum,studentName,text,imageDataUrl){
    const date=nowDateStr(), time=nowTimeStr();
    updateStudentRecord(grade,classNum,(list)=> list.map(s=>{ if(s.name===studentName){ s.status=s.status||"ğŸ”´ ØºØ§Ø¦Ø¨Ø©"; s.absences=s.absences||[]; s.absences.push({date,time,text,image:imageDataUrl}); s.hasNew=true; } return s; }));
    closeReasonModal(); showSnack("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¨Ø¨");
    if(currentRole()==="parent"){ parentOnSelectorsChange(); }
    if(currentRole()==="admin"||currentRole()==="teacher"){ loadStudents(); }
  }

  /* ===== ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø©/Ø¥Ø±Ø³Ø§Ù„ ===== */
  function exportToExcel(){
    const g=$("grade").value,c=$("class").value; if(!g||!c) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const saved=JSON.parse(localStorage.getItem(keyFor(g,c))||"[]"); if(saved.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
    const ws_data=[["Ø±Ù‚Ù…","Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±","Ø±Ù‚Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±"]]; 
    saved.forEach((s,i)=>ws_data.push([i+1,s.name,s.status||"âœ… Ø­Ø§Ø¶Ø±Ø©",s.notes||"", (s.absences||[]).length, s.parentPhone||""]));
    const ws=XLSX.utils.aoa_to_sheet(ws_data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ±");
    const dateStr=new Date().toLocaleDateString("ar-EG").replace(/\//g,"-"); XLSX.writeFile(wb, `ÙƒØ´Ù_Ø§Ù„ØµÙ${g}_Ø§Ù„Ø´Ø¹Ø¨Ø©${c}_${dateStr}.xlsx`);
  }
  async function sendPDF(){
    const g=$("grade").value,c=$("class").value; if(!g||!c) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹");
    const rows=[...document.querySelectorAll("#studentsList tr")]; if(rows.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
    const { jsPDF }=window.jspdf; const doc=new jsPDF({orientation:"portrait",unit:"pt",format:"a4"}); const pageW=doc.internal.pageSize.getWidth(); let y=36;
    doc.setFont("Helvetica","bold"); doc.setFontSize(16); doc.text("Ù…Ø¯Ø±Ø³Ø© Ø¬ÙˆÙ‡Ø±Ø© Ø´Ù†Ø§Øµ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ",pageW/2,y,{align:"center"}); y+=22;
    doc.setFontSize(12); doc.text("Ø³Ù„Ø·Ù†Ø© Ø¹ÙÙ…Ø§Ù†",pageW/2,y,{align:"center"}); y+=18;
    const now=new Date(); const day=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"][now.getDay()];
    doc.setFontSize(11); doc.text(`Ø§Ù„ÙŠÙˆÙ…: ${day}   Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now.toLocaleDateString("ar-EG")}   Ø§Ù„ØµÙ ${g} / Ø§Ù„Ø´Ø¹Ø¨Ø© ${c}`,pageW/2,y,{align:"center"}); y+=18;
    const body=rows.map((r,i)=>[(i+1).toString(), r.querySelector(".name").textContent, r.querySelector(".status").textContent||"âœ… Ø­Ø§Ø¶Ø±Ø©", r.querySelector(".notes").value||"", JSON.parse(r.dataset.absences||"[]").length.toString(), (r.dataset.parentPhone||"")]);
    doc.autoTable({ head:[["Ø±Ù‚Ù…","Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø°Ø§Ø±","Ø±Ù‚Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±"]], body, theme:"grid", styles:{font:"Helvetica",fontSize:11,halign:"center"}, headStyles:{fillColor:[109,76,182], textColor:[255,255,255]}, startY:y });
    const s=computeStats(); let endY=doc.lastAutoTable.finalY+16; doc.setFontSize(12); doc.setFont("Helvetica","bold");
    doc.text(`Ø§Ù„Ø­Ø¶ÙˆØ±: ${s.present}%   |   Ø§Ù„ØºÙŠØ§Ø¨: ${s.absent}%   |   Ø§Ù„ØªØ£Ø®Ø±: ${s.late}%`,pageW/2,endY,{align:"center"});
    const fileName=`ØªÙ‚Ø±ÙŠØ±_Ø­Ø¶ÙˆØ±_Ø§Ù„ØµÙ${g}_Ø§Ù„Ø´Ø¹Ø¨Ø©${c}_${now.toLocaleDateString("ar-EG").replace(/\//g,"-")}.pdf`; doc.save(fileName);
    showSnack("ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF");
  }
  function printList(){ window.print(); }
  function sendReport(){ showTopBanner(); showSnack("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"); }
  function showSnack(msg="âœ… ØªÙ…") { const x=$("snackbar"); x.textContent=msg; x.className="show"; setTimeout(()=>x.className=x.className.replace("show",""),3000); }
  function showTopBanner(){ const b=$("topBanner"); b.style.display="block"; b.style.opacity="0"; setTimeout(()=>{ b.style.transition="opacity .25s"; b.style.opacity="1"; },10); setTimeout(()=>{ b.style.opacity="0"; setTimeout(()=>{ b.style.display="none"; },250); },3000); }

  /* ===== Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªÙˆÙ„ Ø¨Ø§Ø± ===== */
  function setupMenus(){
    setupAddMenu();
    const expMainBtn=$("expMainBtn"), expCaret=$("expCaret"), expMenu=$("expMenu");
    expMainBtn.onclick=(e)=>{ e.stopPropagation(); closeAllMenus(); expMenu.classList.toggle("show"); };
    expCaret.onclick=(e)=>{ e.stopPropagation(); closeAllMenus(); expMenu.classList.toggle("show"); };
    document.addEventListener("click",()=> expMenu.classList.remove("show"));
  }

  /* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===== */
  (function init(){
    if(currentRole()){ routeByRole(); } else { showOnly("loginView"); }
    setupMenus();
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAllMenus(); });
  })();

  /* ===== PWA: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© ===== */
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
  }
</script>

</body>
</html>
